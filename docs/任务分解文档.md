# 即时通讯系统任务分解文档

本文档根据项目需求与设计文档，将整个即时通讯系统的开发工作分解为四个主要阶段和一系列具体任务。每个任务都包含了描述、优先级和依赖关系，以便于项目管理和执行。

---

## 阶段一：基础框架与核心功能 (MVP)

此阶段的目标是搭建项目的骨架，并实现最核心的单聊功能，为后续开发奠定坚实基础。

### **任务 1: 项目设置与环境配置**
- **描述**: 初始化项目结构，配置开发环境，并建立版本控制。
- **优先级**: 高
- **子任务**:
  - 1.1: 使用 Poetry 初始化Python项目并管理依赖。
  - 1.2: 搭建 FastAPI 应用的基本结构。
  - 1.3: 配置并启动 MySQL 和 RabbitMQ 服务（建议使用 Docker Compose）。
  - 1.4: 初始化 Git 仓库，定义主干/开发分支策略。

### **任务 2: 数据库设计与迁移**
- **描述**: 设计并实现核心功能的数据库表结构。
- **优先级**: 高
- **依赖关系**: [任务 1]
- **子任务**:
  - 2.1: 使用 Pydantic 定义用户、会话、消息等核心数据模型。
  - 2.2: 实现与 Pydantic模型对应的 SQLAlchemy ORM 模型。
  - 2.3: 配置 Alembic 用于数据库版本迁移。
  - 2.4: 创建并执行用于生成核心表的第一个迁移脚本。

### **任务 3: 用户认证模块**
- **描述**: 实现用户登录及基于 JWT 的身份认证机制。
- **优先级**: 高
- **依赖关系**: [任务 2]
- **子任务**:
  - 3.1: 创建 `/login` API 接口。
  - 3.2: 实现密码的哈希加密存储与登录验证。
  - 3.3: 用户成功登录后，生成符合 `x-token: Tricolor<...>` 格式的 JWT。
  - 3.4: 创建一个 FastAPI 依赖项，用于验证接口请求中的 `x-token`。

### **任务 4: 核心消息管道（单聊）**
- **描述**: 实现一对一聊天的基础消息发送、存储和接收流程。
- **优先级**: 高
- **依赖关系**: [任务 3]
- **子任务**:
  - 4.1: 设计用于单聊的 RabbitMQ 拓扑结构（交换机、队列）。
  - 4.2: 在消息发送API中实现消息生产者逻辑。
  - 4.3: 创建一个后台消费者服务，用于处理和存储进入队列的消息。
  - 4.4: 实现一个发送文本消息给指定用户的 API 接口。

### **任务 5: 基础API实现**
- **描述**: 为最小化可行客户端提供必要的数据接口。
- **优先级**: 中
- **依赖关系**: [任务 4]
- **子任务**:
  - 5.1: 创建获取用户会话列表的 API。
  - 5.2: 创建获取用户离线消息的 API。

---

## 阶段二：完善功能与用户体验

此阶段在MVP的基础上，扩展群聊、多媒体消息等核心功能，提升系统的实用性。

### **任务 6: 群聊功能**
- **描述**: 开发支持多人会话的完整群聊功能。
- **优先级**: 高
- **依赖关系**: [任务 4]
- **子任务**:
  - 6.1: 实现创建群聊、添加初始成员的 API。
  - 6.2: 实现添加/移除群成员的 API。
  - 6.3: 实现用户主动退出群聊的 API。
  - 6.4: 实现群主解散群聊的 API。
  - 6.5: 调整消息处理逻辑，以支持向群组内所有成员投递消息。

### **任务 7: 多媒体与文件消息**
- **描述**: 增加对图片、语音、视频和各类文件的支持。
- **优先级**: 高
- **依赖关系**: [任务 4]
- **子任务**:
  - 7.1: 配置 Nginx 作为静态文件服务器，处理文件上传和下载。
  - 7.2: 实现文件上传接口，将文件存至服务器并创建消息记录。
  - 7.3: 扩展消息的数据结构，以包含文件URL、类型、大小等信息。
  - 7.4: 确保客户端可以根据消息内容构建正确的文件下载链接。

### **任务 8: 用户在线状态与会话管理**
- **描述**: 实现用户在线状态的实时同步和展示。
- **优先级**: 中
- **依赖关系**: [任务 3]
- **子任务**:
  - 8.1: 设计并实现客户端心跳机制，用于维持和更新在线状态。
  - 8.2: 利用 RabbitMQ 的 fanout 交换机广播用户在线状态的变更。
  - 8.3: 在获取用户信息的接口中，返回实时状态。

### **任务 9: 历史与离线消息功能增强**
- **描述**: 优化消息检索功能，提升用户体验。
- **优先级**: 中
- **依赖关系**: [任务 5]
- **子任务**:
  - 9.1: 实现高效的历史消息分页拉取功能。
  - 9.2: 优化离线消息的获取逻辑，减少延迟。

---

## 阶段三：高级功能与系统集成

此阶段主要开发广播、事件等高级功能，并启动客户端的开发工作。

### **任务 10: 广播与系统事件**
- **描述**: 开发系统级的广播通知和客户端事件上报功能。
- **优先级**: 中
- **依赖关系**: [任务 4]
- **子任务**:
  - 10.1: 创建一个仅限管理员使用的广播发送 API。
  - 10.2: 为广播和事件设计专用的 RabbitMQ 拓扑。
  - 10.3: 实现客户端上报自定义事件的 API 接口。

### **任务 11: 客户端初步开发**
- **描述**: 开发一个基础的客户端（Web或PC），用于测试和展示后端功能。
- **优先级**: 高
- **依赖关系**: [阶段二所有任务]
- **子任务**:
  - 11.1: 搭建登录、会话列表、聊天窗口等基础UI界面。
  - 11.2: 通过 WebSocket 或其他实时技术连接后端，接收实时消息。
  - 11.3: 实现消息的发送、接收和展示。
  - 11.4: 展示用户的在线状态和会话历史。

---

## 阶段四：联邦化与跨系统通信

此阶段是项目的最终目标，实现与其他独立IM系统的互联互通。

### **任务 12: 联邦架构基础搭建**
- **描述**: 对数据库和核心组件进行扩展，以支持联邦化架构。
- **优先级**: 高
- **依赖关系**: [阶段三所有任务]
- **子任务**:
  - 12.1: 实现数据库 schema 变更（增加 `federation_configs` 和 `external_users` 表）。
  - 12.2: 在系统中定义跨域用户身份标识（例如 `user@domain`）。
  - 12.3: 在 FastAPI 应用中创建一个新的 `federation` 模块。

### **任务 13: 跨系统安全机制**
- **描述**: 为服务器之间的安全通信实现认证和授权。
- **优先级**: 高
- **依赖关系**: [任务 12]
- **子任务**:
  - 13.1: 实现用于服务器间通信的 JWT 生成与验证逻辑。
  - 13.2: 实现对跨域消息的数字签名和验证，确保消息的完整性和来源可信。

### **任务 14: 联邦API**
- **描述**: 创建联邦化通信所必需的API接口。
- **优先级**: 高
- **依赖关系**: [任务 13]
- **子任务**:
  - 14.1: 用户发现API (`/federation/users/{user_id}`).
  - 14.2: 外部消息投递API (`/federation/messages/deliver`).
  - 14.3: 用户在线状态同步API (`/federation/presence/sync`).

### **任务 15: 联邦消息路由**
- **描述**: 配置 RabbitMQ 和应用层逻辑，以处理跨域消息的路由。
- **优先级**: 高
- **依赖关系**: [任务 14]
- **子任务**:
  - 15.1: 部署并配置 RabbitMQ Federation 插件，连接到另一个IM系统的MQ。
  - 15.2: 更新消息处理逻辑，使其能够区分本地和远程接收者。
  - 15.3: 实现当检测到远程接收者时，调用对方服务器的联邦投递API。

### **任务 16: 端到端联邦测试**
- **描述**: 部署一个独立的IM系统实例，并对所有联邦功能进行完整测试。
- **优先级**: 高
- **依赖关系**: [任务 15]
- **子任务**:
  - 16.1: 部署两套独立的IM系统实例。
  - 16.2: 测试在两个系统间的用户发现功能。
  - 16.3: 测试双向的消息收发。
  - 16.4: 测试跨系统的用户在线状态同步。 