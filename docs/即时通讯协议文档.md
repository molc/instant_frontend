即时通讯

接口协议说明书

|      |  |
| ---- | - |
| 编制 |  |
| 审批 |  |

**目录**

[1.修订记录 4](#_Toc193383478)

[2.协议约定 5](#_Toc193383479)

[2.1 协议格式 5](#_Toc193383480)

[2.2 协议流程 5](#_Toc193383481)

[2.3 错误码介绍 5](#_Toc193383482)

[2.4 其他约定： 5](#_Toc193383483)

[3.协议内容 5](#_Toc193383484)

[3.1 http协议 5](#_Toc193383485)

[3.1.1会话列表获取 5](#_Toc193383486)

[3.1.2会话创建 6](#_Toc193383487)

[3.1.3会话加人 7](#_Toc193383488)

[3.1.4会话剔人 7](#_Toc193383489)

[3.1.5退出会话 8](#_Toc193383490)

[3.1.6修改会话名称 9](#_Toc193383491)

[3.1.7心跳保持 9](#_Toc193383492)

[3.1.8离线消息获取 9](#_Toc193383493)

[3.1.9未读消息获取 11](#_Toc193383494)

[3.1.10历史消息获取 12](#_Toc193383495)

[3.1.11解散群聊 13](#_Toc193383496)

[3.1.12转让群主 13](#_Toc193383497)

[3.1.13查询离线广播 14](#_Toc193383498)

[3.1.14查询未读广播 15](#_Toc193383499)

[3.1.15查询历史广播 16](#_Toc193383500)

[3.1.16发送广播 17](#_Toc193383501)

[3.1.17查询历史事件 19](#_Toc193383502)

[3.1.18上报事件 20](#_Toc193383503)

[3.1.19即时消息发送 21](#_Toc193383504)

[3.1.20即时文本消息发送 22](#_Toc193383505)

[3.1.21即时消息文件下载 23](#_Toc193383506)

[3.2 级联对外协议 24](#_Toc193383507)

[3.2.1查询融合服务列表 24](#_Toc193383508)

[3.2.2查询sip话机 25](#_Toc193383509)

[3.3 即时通讯级联协议 26](#_Toc193383510)

[3.3.1用户导入 26](#_Toc193383511)

[3.3.2用户状态更新 27](#_Toc193383512)

[3.3.3用户token饱和 27](#_Toc193383513)

[3.4 MQ消息协议 28](#_Toc193383514)

[3.4.1接收即时消息 28](#_Toc193383515)

[3.4.2会话创建通知 28](#_Toc193383516)

[3.4.3退出会话通知 29](#_Toc193383517)

[3.4.4修改会话名称通知 29](#_Toc193383518)

[3.4.5会话加人通知 30](#_Toc193383519)

[3.4.6会话剔人通知 30](#_Toc193383520)

[3.4.7用户离线通知 31](#_Toc193383521)

[3.4.8用户上线通知 31](#_Toc193383522)

[3.4.9解散群组通知 32](#_Toc193383523)

[3.4.10群主转让通知 32](#_Toc193383524)

[3.4.11广播接收 32](#_Toc193383525)

[3.4.12事件接收 33](#_Toc193383526)

# 修订记录

|                |                    |                |                  |                                                                                                                      |
| -------------- | ------------------ | -------------- | ---------------- | -------------------------------------------------------------------------------------------------------------------- |
| **序号** | **变更时间** | **版本** | **变更人** | **变更说明**                                                                                                   |
| 1              | 2024-07-12         | V1.0.0         | 莫林成           | 新建                                                                                                                 |
| 2              | 2025-04-03         | V1.0.1         | 喻春潮           | 修改，修改接口地址前缀为instant                                                                                      |
| 3              | 2025-04-16         | V1.0.2         | 喻春潮           | 修改，修改3.2查询接口描述，接口实际为center实现（免登录接口）                                                        |
| 4              | 2025-04-30         | V1.0.3         | 喻春潮           | 新增，补充添加3.4.13、 3.4.14接口 3.3.3接口                                                                          |
| 5              | 2025-06-11         | V1.0.4         | 喻春潮           | 修改、删除，3.1.2会话创建 添加可选字段conversation\_id ；补充3.1.16接口中NGINX对外地址和type参数说明；移除3.4.14协议 |

# 协议约定

## 协议格式

1. 均采用http+json方式
2. 使用restful协议规范,查询接口使用GET请求方式,新增接口使用POST请求方式,修改接口使用PUT请求方式,删除接口使用POST请求方式
3. 通过3.3.1和3.3.2协议实现添加用户、用户上线的功能
4. 3.3.2协议中的token为用户登录token,token放置在请求头中进行传输,格式为x-token:Tricolor`<xxxxxxx>`

## 协议流程

协议主要以请求－应答方式,即client/server

## 错误码介绍

结果返回使用http返回code

0或200: 表示请求成功

400－500：对应http 协议请求失败错误 ,

失败返回：｛"code": 非0且非200, "reason":"失败原因"｝

## 其他约定：

# 协议内容

## http协议（即时通信对外接口）

### 会话列表获取

|                                  |                                                                                                                                                                                                                                                                                  |      |      |      |
| -------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ---- | ---- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                  |      |      |      |
| URL                              | http://ip:port/instant/c\_conversation                                                                                                                                                                                                                                           |      |      |      |
| 方法                             | GET                                                                                                                                                                                                                                                                              |      |      |      |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                             | 类型 | 含义 | 说明 |
| 返回示例                         | {  "code": 0,  "data": [  {  "name": "会话名称",  "type": "会话类型", //single/group  "conversation\_id": "唯一字符串",  "master\_standard\_id": "20位国标ID",  "persons": [  {  "standard\_id": "20位国标ID ",  "user\_status": 0,1 0是正常，1表示用户已经被删除  }  ]  }  ]  } |      |      |      |
| 返回说明                         | 名称                                                                                                                                                                                                                                                                             | 类型 | 含义 | 说明 |

### 会话创建

|                                  |                                                                                                                                                                                                                      |        |                |                                                  |
| -------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------ | -------------- | ------------------------------------------------ |
| client<-------->instant\_service |                                                                                                                                                                                                                      |        |                |                                                  |
| URL                              | http://ip:port/instant/c\_conversation                                                                                                                                                                               |        |                |                                                  |
| 方法                             | POST                                                                                                                                                                                                                 |        |                |                                                  |
| 参数说明                         | 名称                                                                                                                                                                                                                 | 类型   | 含义           | 说明                                             |
|                                  | conversation\_id                                                                                                                                                                                                     | String | 会话ID         | 可选字段，不传时后台生成；传参时后台直接使用该值 |
| 请求体示例                       | {  "action": "create",  "name": "会话名称",  "type": "会话类型", //single, group  "master\_standard\_id": "20位国标ID ",  "conversation\_id": "UUID随机数",  "persons": [  {  "standard\_id": "20位国标ID "  }  ]  } |        |                |                                                  |
| 返回说明                         | 名称                                                                                                                                                                                                                 | 类型   | 含义           | 说明                                             |
|                                  | type                                                                                                                                                                                                                 | String | 会话类型       | single 单聊  group群聊                           |
|                                  | action                                                                                                                                                                                                               | String | 操作会话的动作 | create 创建                                      |
| 返回示例                         | {  "code": 0,  "data ": {  "conversation\_id": "唯一字符串",  "create\_utctime": 1742865822.839207  }  }                                                                                                             |        |                |                                                  |

### 会话加人

|                                  |                                                                                                      |      |      |      |
| -------------------------------- | ---------------------------------------------------------------------------------------------------- | ---- | ---- | ---- |
| client<-------->instant\_service |                                                                                                      |      |      |      |
| URL                              | http://ip:port/instant/c\_conversation                                                               |      |      |      |
| 方法                             | PUT                                                                                                  |      |      |      |
| 参数说明                         | 名称                                                                                                 | 类型 | 含义 | 说明 |
| 请求体示例                       | {  "action": "add",  "conversation\_id": "唯一字符串",  "persons": [  {  "standard\_id": ""  }  ]  } |      |      |      |
| 返回说明                         | 名称                                                                                                 | 类型 | 含义 | 说明 |
| 返回示例                         | {  "code": 0  }                                                                                      |      |      |      |

### 会话剔人

|                                  |                                                                                                         |      |      |      |
| -------------------------------- | ------------------------------------------------------------------------------------------------------- | ---- | ---- | ---- |
| client<-------->instant\_service |                                                                                                         |      |      |      |
| URL                              | http://ip:port/instant/c\_conversation                                                                  |      |      |      |
| 方法                             | PUT                                                                                                     |      |      |      |
| 参数说明                         | 名称                                                                                                    | 类型 | 含义 | 说明 |
| 请求体示例                       | {  "action": "delete",  "conversation\_id": "唯一字符串",  "persons": [  {  "standard\_id": ""  }  ]  } |      |      |      |
| 返回说明                         | 名称                                                                                                    | 类型 | 含义 | 说明 |
| 返回示例                         | {  "code": 0  }                                                                                         |      |      |      |

### 退出会话

|                                  |                                                                                                |      |      |      |
| -------------------------------- | ---------------------------------------------------------------------------------------------- | ---- | ---- | ---- |
| client<-------->instant\_service |                                                                                                |      |      |      |
| URL                              | http://ip:port/instant/c\_conversation                                                         |      |      |      |
| 方法                             | PUT                                                                                            |      |      |      |
| 参数说明                         | 名称                                                                                           | 类型 | 含义 | 说明 |
| 请求体示例                       | {  "action": "quit",  "conversation\_id": "唯一字符串",  "person": {  "standard\_id": ""  }  } |      |      |      |
| 返回说明                         | 名称                                                                                           | 类型 | 含义 | 说明 |
| 返回示例                         | {  "code": 0  }                                                                                |      |      |      |

### 修改会话名称

|                                  |                                                                                        |      |      |      |
| -------------------------------- | -------------------------------------------------------------------------------------- | ---- | ---- | ---- |
| client<-------->instant\_service |                                                                                        |      |      |      |
| URL                              | http://ip:port/instant/c\_conversation                                                 |      |      |      |
| 方法                             | PUT                                                                                    |      |      |      |
| 参数说明                         | 名称                                                                                   | 类型 | 含义 | 说明 |
| 请求体示例                       | {  "action": "update\_name",  "conversation\_id": "唯一字符串",  "name": "会话名称"  } |      |      |      |
| 返回说明                         | 名称                                                                                   | 类型 | 含义 | 说明 |
| 返回示例                         | {  "code": 0  }                                                                        |      |      |      |

### 离线消息获取

|                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |      |      |      |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ---- | ---- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |      |      |      |
| URL                              | http://ip:port/instant/c\_message\_offline                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |      |      |      |
| 方法                             | get                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |      |      |      |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 类型 | 含义 | 说明 |
| 返回说明                         | 名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 类型 | 含义 | 说明 |
| 返回示例                         | {  "code": 0,  "data": [  {  "conversation\_id": "唯一字符串",  "messeages": [  {  "id": "唯一字符串",  "create\_time": "", //消息时间，格式为20240720122334  "publisher\_standard\_id": "",  "profile": [  {  "id": 0,  "type": 1, //消息类型，0-文本消息，1-语音，2-图片，3-文本文档，4-PDF，5-DOC，6-EXCEL，7-PPT，8-音频文件，9-视频文件，10-压缩文件，11-未知类型  "name": "", //当类型为0时为文本内容，非0时为文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  ]  }  ]  } |      |      |      |
|                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |      |      |      |

### 未读消息获取

|                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                        |                                     |                |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ----------------------------------- | -------------- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                        |                                     |                |
| URL                              | http://ip:port/instant/c\_message\_unread                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                        |                                     |                |
| 方法                             | get                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                        |                                     |                |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 类型                   | 含义                                | 说明           |
| conversation\_id                 | string                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 获取该会话的未读消息   |                                     |                |
|                                  | offset                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | string(yyyymmddHHMMSS) | 从哪一时间点开始,到当前时间所有信息 | 20240720122334 |
| 返回示例                         | {  "code": 0,  "data": [  {  "conversation\_id": "唯一字符串",  "messeages": [  {  "id": "唯一字符串",  "create\_time": "", //消息时间，格式为20240720122334  "publisher\_standard\_id": "",  "profile": [  {  "id": 0,  "type": 1, //消息类型，0-文本消息，1-语音，2-图片，3-文本文档，4-PDF，5-DOC，6-EXCEL，7-PPT，8-音频文件，9-视频文件，10-压缩文件，11-未知类型  "name": "", //当类型为0时为文本内容，非0时为文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  ]  }  ]  } |                        |                                     |                |

### 历史消息获取

|                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                        |                           |                |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ------------------------- | -------------- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                        |                           |                |
| URL                              | http://ip:port/instant/c\_message\_history                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                        |                           |                |
| 方法                             | get                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                        |                           |                |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 类型                   | 含义                      | 说明           |
| conversation\_id                 | string                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 获取该会话的历史消息   |                           |                |
|                                  | offset                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | string(yyyymmddHHMMSS) | 从哪一时间点开始,往前获取 | 20240720122334 |
|                                  | limit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | int                    | 获取多少条历史消息        |                |
| 返回示例                         | {  "code": 0,  "data": [  {  "conversation\_id": "唯一字符串",  "messeages": [  {  "id": "唯一字符串",  "create\_time": "", //消息时间，格式为20240720122334  "publisher\_standard\_id": "",  "profile": [  {  "id": 0,  "type": 1, //消息类型，0-文本消息，1-语音，2-图片，3-文本文档，4-PDF，5-DOC，6-EXCEL，7-PPT，8-音频文件，9-视频文件，10-压缩文件，11-未知类型  "name": "", //当类型为0时为文本内容，非0时为文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  ]  }  ]  } |                        |                           |                |
| 返回说明                         | 消息记录以倒序返回                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                        |                           |                |

### 解散群聊

|                                  |                                                                    |
| -------------------------------- | ------------------------------------------------------------------ |
| client<-------->instant\_service |                                                                    |
| URL                              | http://ip:port/instant/c\_conversation                             |
| 方法                             | put                                                                |
| 请求体示例                       | {  "action": "dissolution",  "conversation\_id": ""唯一字符串""  } |
| 返回说明                         | {  "code": 0  }                                                    |

### 转让群主

|                                  |                                                                                                           |
| -------------------------------- | --------------------------------------------------------------------------------------------------------- |
| client<-------->instant\_service |                                                                                                           |
| URL                              | http://ip:port/instant/c\_conversation                                                                    |
| 方法                             | put                                                                                                       |
| 请求体示例                       | {  "action": "change\_master",  "conversation\_id": "唯一字符串", //会话id  "master\_standard\_id": ""  } |
| 返回说明                         | {  "code": 0  }                                                                                           |

### 查询离线广播

|                                  |                                                                                                                                                                                                                                                                                                                             |      |      |      |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ---- | ---- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                             |      |      |      |
| URL                              | http://ip:port/instant/c\_broadcast\_offline                                                                                                                                                                                                                                                                                |      |      |      |
| 方法                             | get                                                                                                                                                                                                                                                                                                                         |      |      |      |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                        | 类型 | 含义 | 说明 |
|                                  |                                                                                                                                                                                                                                                                                                                             |      |      |      |
| 返回示例                         | {  "code": 0,  "data": {  "broadcasts": [  {  "id": 10,  "create\_time": "", //消息时间，格式为20240720122334  "publisher\_standard\_id": "",  "body ": "消息内容",  "profile": [  {  "id": 0,  "type": 1, //1-语音  "name": "", //文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  ]  }  } |      |      |      |
| 返回说明                         | 消息记录以倒序返回, // 类型： 1语音,2图片, 3视频                                                                                                                                                                                                                                                                            |      |      |      |

### 查询未读广播

|                                  |                                                                                                                                                                                                                                                                                                                             |                                     |                |      |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------- | -------------- | ---- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                             |                                     |                |      |
| URL                              | http://ip:port/instant/c\_broadcast\_unread                                                                                                                                                                                                                                                                                 |                                     |                |      |
| 方法                             | get                                                                                                                                                                                                                                                                                                                         |                                     |                |      |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                        | 类型                                | 含义           | 说明 |
| offset                           | string(yyyymmddHHMMSS)                                                                                                                                                                                                                                                                                                      | 从哪一时间点开始,到当前时间所有信息 | 20240720122334 |      |
| 返回示例                         | {  "code": 0,  "data": {  "broadcasts": [  {  "id": 10,  "create\_time": "", //消息时间，格式为20240720122334  "publisher\_standard\_id": "",  "body ": "消息内容",  "profile": [  {  "id": 0,  "type": 1, //1-语音  "name": "", //文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  ]  }  } |                                     |                |      |
| 返回说明                         | 消息记录以倒序返回, // 类型： 1语音,2图片, 3视频                                                                                                                                                                                                                                                                            |                                     |                |      |

### 查询历史广播

|                                  |                                                                                                                                                                                                                                                                                                                             |                        |                           |                |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ------------------------- | -------------- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                             |                        |                           |                |
| URL                              | http://ip:port/instant/c\_broadcast\_history                                                                                                                                                                                                                                                                                |                        |                           |                |
| 方法                             | get                                                                                                                                                                                                                                                                                                                         |                        |                           |                |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                        | 类型                   | 含义                      | 说明           |
|                                  | offset                                                                                                                                                                                                                                                                                                                      | string(yyyymmddHHMMSS) | 从哪一时间点开始,往前获取 | 20240720122334 |
|                                  | limit                                                                                                                                                                                                                                                                                                                       | int                    | 获取多少条历史广播        |                |
| 返回示例                         | {  "code": 0,  "data": {  "broadcasts": [  {  "id": 10,  "create\_time": "", //消息时间，格式为20240720122334  "publisher\_standard\_id": "",  "body ": "消息内容",  "profile": [  {  "id": 0,  "type": 1, //1-语音  "name": "", //文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  ]  }  } |                        |                           |                |
| 返回说明                         | 消息记录以倒序返回 profile type类型： 1语音, 2图片, 3视频                                                                                                                                                                                                                                                                   |                        |                           |                |

### 查询历史事件

|                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                        |                           |                |
| -------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ------------------------- | -------------- |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                        |                           |                |
| URL                              | http://ip:port/instant/c\_event\_history                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                        |                           |                |
| 方法                             | get                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                        |                           |                |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 类型                   | 含义                      | 说明           |
|                                  | offset                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | string(yyyymmddHHMMSS) | 从哪一时间点开始,往前获取 | 20240720122334 |
|                                  | limit                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | int                    | 获取多少条历史事件        |                |
| 返回示例                         | {  "code": 0,  "data": {  "events": [  {  "id": 10,  "create\_time": "", //消息时间，格式为20240720122334  "publisher\_standard\_id": "",  "body ": "", //事件内容  "longitude": "", //经度，如 22.123  "latitude": "", //纬度，如 100.2  "profile": [  {  "id": 11,  "name": "名称",  "type": 1, //1-语音文件，2-图片，3-视频文件  "path": "", //存放路径,/files/event/202406/voice/xxxx,每月创建一个文件夹,xxxx是对应的文件名称, voice、image、video分别是语音、图片、视频文件夹  "audio\_duration": 0 //语音文件时长  }  ]  }  ]  }  } |                        |                           |                |
| 返回说明                         | 消息记录以倒序返回 profile type类型： 1语音, 2图片, 3视频                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                        |                           |                |

### 即时消息发送、发送广播、上报事件

Nginx中对外路径（包含文件上传）/uploads ，后端接口路径 /instant/c\_message

|                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |      |      |      |      |      |                    |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ---- | ---- | ---- | ---- | ------------------ |
| client<-------->instant\_service |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |      |      |      |      |      |                    |
| URL                              | http://ip:port/uploads?type=message                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |      |      |      |      |      |                    |
| 方法                             | POST                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |      |      |      |      |      |                    |
| 请求头示例                       | POST /app/c\_message HTTP/1.1 Accept: application/json, text/plain, \*/\* Accept-Encoding: gzip, deflate Accept-Language: zh-CN,zh;q=0.9,en;q=0.8 Connection: keep-alive Content-Length: 53210 Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7OTdAxNjKJlG8v6p Host: 172.19.103.122:64432 Origin: http://localhost:8080 Referer: http://localhost:8080/ User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10\_15\_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36 x-token: Tricolor<4aed382fead9ba96657c4d0a27f5ac82>                                                                                                                                                                                                                                                                                                                                            |      |      |      |      |      |                    |
| 参数说明                         | 名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 类型 |      | 含义 |      | 说明 |                    |
|                                  | ------WebKitFormBoundary7OTdAxNjKJlG8v6p Content-Disposition: form-data; name="file"; filename="0128.xlsx" Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet  二进制文件数据  ------WebKitFormBoundary7OTdAxNjKJlG8v6p Content-Disposition: form-data; name="file"; filename="2016-8-2.xlsx" Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet  二进制文件数据  ------WebKitFormBoundary7OTdAxNjKJlG8v6p Content-Disposition: form-data; name="data"  {  "conversation\_id": "唯一字符串", //会话id  "publisher\_standard\_id": "",  "profile": [  {  "type": 1, //消息类型，0-消息文本，1-语音，2-图片，3-文本文档，4-PDF，5-DOC，6-EXCEL，7-PPT，8-音频文件，9-视频文件，10-压缩文件，11-未知类型  "name": "", //当类型为0时为文本内容，非0时为文件名称  "audio\_duration": 0 //语音文件时长  }  ]  }  ------WebKitFormBoundary7OTdAxNjKJlG8v6p |      |      |      |      |      |                    |
| 请求参数说明                     | type=message 消息  type=broadcast 广播  type=message 事件                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |      |      |      |      |      |                    |
| 返回示例                         | {  "code": 0,  "data": {  "msg\_id": 0  }  }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |      |      |      |      |      |                    |
| 返回说明                         | 名称                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |      | 类型 |      | 含义 |      | 说明               |
| http code                        |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |      |      |      |      |      | 返回200 OK表示正常 |

### 即时文本消息发送

|                                  |                                                                                                                                   |      |      |      |      |      |                    |
| -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- | ---- | ---- | ---- | ---- | ---- | ------------------ |
| client<-------->instant\_service |                                                                                                                                   |      |      |      |      |      |                    |
| URL                              | http://ip:port/instant/c\_message\_text                                                                                           |      |      |      |      |      |                    |
| 方法                             | POST                                                                                                                              |      |      |      |      |      |                    |
| 请求头示例                       | {  "conversation\_id": "唯一字符串", //会话id  "publisher\_standard\_id": "",  "profile": [  {  "type": 0,  "name": "hi"  }  ]  } |      |      |      |      |      |                    |
| 参数说明                         | 名称                                                                                                                              | 类型 |      | 含义 |      | 说明 |                    |
| 返回示例                         | {  "code": 0,  "data": {  "msg\_id": 0  }  }                                                                                      |      |      |      |      |      |                    |
| 返回说明                         | 名称                                                                                                                              |      | 类型 |      | 含义 |      | 说明               |
| http code                        |                                                                                                                                   |      |      |      |      |      | 返回200 OK表示正常 |

### 即时消息文件下载

|                                  |                                         |      |      |      |      |      |                    |
| -------------------------------- | --------------------------------------- | ---- | ---- | ---- | ---- | ---- | ------------------ |
| client<-------->instant\_service |                                         |      |      |      |      |      |                    |
| URL                              | [http://ip:port/](http://ip:port/)文件path |      |      |      |      |      |                    |
| 方法                             | get                                     |      |      |      |      |      |                    |
| 请求头示例                       |                                         |      |      |      |      |      |                    |
| 参数说明                         | 名称                                    | 类型 |      | 含义 |      | 说明 |                    |
|                                  |                                         |      |      |      |      |      |                    |
| 返回示例                         |                                         |      |      |      |      |      |                    |
| 返回说明                         | 名称                                    |      | 类型 |      | 含义 |      | 说明               |
| http code                        |                                         |      |      |      |      |      | 返回200 OK表示正常 |

## MQ连接信息（中心服务实现 免登录接口）

### 查询即时通讯MQ

|                                 |                                                                                                                                          |      |      |      |      |      |      |
| ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | ---- | ---- | ---- | ---- | ---- | ---- |
| client<-------->center\_service |                                                                                                                                          |      |      |      |      |      |      |
| URL                             | http://ip:port/app/p\_mq                                                                                                                 |      |      |      |      |      |      |
| 方法                            | GET                                                                                                                                      |      |      |      |      |      |      |
| 参数说明                        | 名称                                                                                                                                     | 类型 |      | 含义 |      | 说明 |      |
| 返回示例                        | {  "code": 0,  "data": {  "host": "172.19.102.81",  "port": 5672,  "user": "instant",  "vhost": "/instant",  "password": "instant"  }  } |      |      |      |      |      |      |
| 返回说明                        | 名称                                                                                                                                     |      | 类型 |      | 含义 |      | 说明 |

## 即时通讯级联协议（中心服务实现 生产者）

### 用户导入

|            |                                                                                                                                                               |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                                       |
| route key  | instant.base                                                                                                                                                  |
| queue      | queue\_instant\_base                                                                                                                                          |
| 消息体示例 | {  "cmd": "user\_import",  "data": [  {  "standard\_id": "20位国标平台ID ",  "name": "李风",  "sex": 0/1,0:男，1：女  "platform\_id": 20位国标平台ID  }  ]  } |

### 用户状态更新

|            |                                                                                                                                                                                                             |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                                                                                     |
| route key  | instant.base                                                                                                                                                                                                |
| queue      | queue\_instant\_base                                                                                                                                                                                        |
| 消息体示例 | {  "cmd": "user\_status\_update",  "data": [  {  "standard\_id": "20位国标平台ID ",  "online": 0/1,0:离线，1：在线  "platform\_id": 20位国标平台ID,  "type": 2, 1:pc, 2:app  "token": "唯一字符串"  }  ]  } |
|            |                                                                                                                                                                                                             |

### 水印修改通知

|            |                                                                                                                                             |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                     |
| route key  | instant.base                                                                                                                                |
| queue      | queue\_instant\_base                                                                                                                        |
| 消息体示例 | {"cmd": "update\_water\_mark",  "data": {  "id": 1,  "mark": true,  "transparency": 41,  "name": true,  "phone": false,  "date": true  }  } |
|            |                                                                                                                                             |

### 其他级联平台mq信息更新

级联时同步其他平台MQ信息

|            |                                                                                                                                                                                                                                                    |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                                                                                                                            |
| route key  | instant.base                                                                                                                                                                                                                                       |
| queue      | queue\_instant\_base                                                                                                                                                                                                                               |
| 消息体示例 | {  "cmd": "platform\_mq\_update",  "data": [  {  "platform\_id": "42000000050000000005", 平台国标id  "mq\_host": "172.19.102.126", 平台IP  "mq\_port": 5672,  "mq\_user": "instant",  "mq\_password": "instant",  "mq\_vhost": "/instant"  }  ]  } |
|            |                                                                                                                                                                                                                                                    |

## MQ消息协议（客户端实现 消费者）

### 接收即时消息

|            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_c\_xxx                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| route key  | c\_xxx xxx为会话id                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户id, \*\*\*为随机串,离线时删除                                                                                                                                                                                                                                                                                                                                                                                                           |
| 消息体示例 | {  "cmd": "msg",  "data": {  "id": "",  "conversation\_id": 1, //会话id  "create\_time": "", //广播时间，格式为20240720122334  "publisher\_standard\_id": "",  "profile": [  {  "id": 0,  "type": 1, //消息类型，0-文本内容，1-语音，2-图片，3-文本文档，4-PDF，5-DOC，6-EXCEL，7-PPT，8-音频文件，9-视频文件，10-压缩文件，11-未知类型  "name": "", //当类型为0时为文本内容，非0时为文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  } |

### 会话创建通知

|            |                                                                                                                                                                                                                                    |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                                                                                                            |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                                                                                                                                                                   |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                                                                                                                                                                  |
| 消息体示例 | {  "cmd": "create\_conversation",  "data": {  "conversation\_id": "唯一字符串",  "type":"", //分组类型  "name": "会话名称",  "master\_standard\_id":"", //主持人国标ID  "persons": [  {  "id": 10,  "standard\_id": ""  }  ]  }  } |

### 退出会话通知

|            |                                                                                                                                |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------ |
| exchange   | exchange\_instant\_base                                                                                                        |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                                                               |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID \*\*\*为随机串,离线时删除                                                               |
| 消息体示例 | {  "cmd": "quit\_conversation",  "data": {  "conversation\_id": "会话id",  "person": {  "id": 10,  "standard\_id": ""  }  }  } |

### 修改会话名称通知

|            |                                                                                                             |
| ---------- | ----------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                     |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                                            |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                                           |
| 消息体示例 | {  "cmd": "update\_name\_conversation",  "data": {  "conversation\_id": "会话id",  "name": "会话名称"  }  } |

### 会话加人通知

|            |                                                                                                                            |
| ---------- | -------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                    |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                                                           |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                                                          |
| 消息体示例 | {  "cmd": "join\_conversation",  "data": {  "conversation\_id": "会话id",  "persons": [  {  "standard\_id": ""  }  ]  }  } |

### 会话剔人通知

|            |                                                                                                                                             |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                     |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                                                                            |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                                                                           |
| 消息体示例 | {  "cmd": " expulsion\_conversation",  "data": {  "conversation\_id": "会话id",  "persons": [  {  "id": 10,  "standard\_id": ""  }  ]  }  } |

### 用户离线通知

|            |                                                                                                       |
| ---------- | ----------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                               |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                                      |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                                     |
| 消息体示例 | {  "cmd": "offline\_conversation",  "data": {  "person": [  {  "standard\_id": 用户国标ID  }  ]  }  } |

### 用户上线通知

|            |                                                                                            |
| ---------- | ------------------------------------------------------------------------------------------ |
| exchange   | exchange\_instant\_base                                                                    |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                           |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                          |
| 消息体示例 | {  "cmd": "online\_conversation",  "data": {  "person": [  {  "id": 用户国标ID  }  ]  }  } |

### 解散群组通知

|            |                                                                                        |
| ---------- | -------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                       |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                      |
| 消息体示例 | {  "cmd": " dissolution\_conversation",  "data": {  "conversation\_id": "会话id"  }  } |

### 群主转让通知

|            |                                                                                                                       |
| ---------- | --------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                               |
| route key  | u\_xxx xxx为参与会话的用户国标ID                                                                                      |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户国标ID, \*\*\*为随机串,离线时删除                                                     |
| 消息体示例 | {  "cmd": "change\_master\_conversation",  "data": {  "conversation\_id": "会话id",  "master\_standard\_id": ""  }  } |

### 广播接收

|            |                                                                                                                                                                                                                                                                                                               |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                                                                                                                                                                                       |
| route key  | broadcast                                                                                                                                                                                                                                                                                                     |
| 消息体示例 | {  "cmd": "broadcast",  "data": {  "id": "唯一字符串",,  "create\_time": "", //广播时间，格式为20240720122334  "publisher\_standard\_id": "",  "body ": "",  "profile": [  {  "id": 0,  "type": 1, //1-语音  "name": "", //文件名称  "path ": "", //存放路径  "audio\_duration": 0 //语音文件时长  }  ]  }  } |

### 事件接收

|            |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| route key  | event                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 消息体示例 | {  "cmd": "event",  "data": {  "id": "唯一字符串",  "create\_time": "", //事件上传时间，格式为20240720122334  "publisher\_standard\_id": " ",  "longitude": "22.123",  "latitude": "100.2",  "body ": "消息内容",  "profile": [  {  "id": 0,  "name": "名称",  "type": 1, //1-语音文件，2-图片，3-视频文件  "path": "存放路径 /files/event/202406/voice/xxxx, 每月创建一个文件夹,xxxx是对应的文件名称, voice、image、video分别是语音、图片、视频文件夹",  "audio\_duration": 0 //语音文件时长  }  ]  }  } |

### 水印修改通知

**中心服务发送消息，即时通信服务转发消息**

|            |                                                                                                                                             |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| exchange   | exchange\_instant\_base                                                                                                                     |
| route key  | u\_.water\_mark                                                                                                                             |
| queue      | queue\_u\_xxx\_\*\*\*, xxx为用户id, \*\*\*为随机串,离线时删除                                                                               |
| 消息体示例 | {"cmd": "update\_water\_mark",  "data": {  "id": 1,  "mark": true,  "transparency": 41,  "name": true,  "phone": false,  "date": true  }  } |

### 用户位置上报（移除）

**客户端发送，中心服务接收处理此消息，即时通信中关注此消息，参考中心与客户端文档**
