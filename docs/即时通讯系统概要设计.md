# 即时通讯系统概要设计

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 即时通讯系统概要设计 (v3.0) |
| 版本 | V3.0.0 |
| 编制时间 | 2024年 |
| 技术栈 | Python 3.12 + FastAPI + SQLAlchemy + RabbitMQ + Redis |

## 目录

1. [系统架构设计](#系统架构设计)
2. [技术栈选择](#技术栈选择)
3. [项目结构设计](#项目结构设计)
4. [数据库设计](#数据库设计)
5. [API接口设计](#api接口设计)
6. [实时通信与消息队列设计](#实时通信与消息队列设计)
7. [核心模块设计](#核心模块设计)
8. [安全设计](#安全设计)
9. [部署架构](#部署架构)

## 系统架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端层 (Client Layer)                    │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│   Web客户端  │  移动端APP  │   桌面应用   │     第三方应用    │
└─────────────┴─────────────┴─────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   负载均衡层 (Load Balancer)                 │
├─────────────────────────────────────────────────────────────┤
│                      Nginx / Traefik                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   应用服务层 (Application Layer)             │
├─────────────┬─────────────┬─────────────┬─────────────────┤
│  FastAPI    │   实时通信服务  │   文件服务   │     认证服务      │
│  (主应用)    │  (WebSocket)  │             │                 │
└─────────────┴─────────────┴─────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   中间件层 (Middleware Layer)                │
├─────────────────────┬───────────────────────────────────────┤
│    RabbitMQ        │             Redis                     │
│   消息队列          │        缓存 / 在线状态管理              │
└─────────────────────┴───────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据存储层 (Data Layer)                    │
├─────────────────────┬───────────────────────────────────────┤
│      MySQL         │          本地文件系统                   │
│    关系数据库       │         (./uploads)                  │
└─────────────────────┴───────────────────────────────────────┘
```

### 服务架构

```
┌──────────────────────────────────────────────────────────────────────────┐
│                             即时通讯系统服务架构                           │
├──────────────────────────────────────────────────────────────────────────┤
│ ┌───────────────┐ ┌───────────────┐ ┌──────────────────┐ ┌──────────────────┐ │
│ │   用户服务    │ │   会话服务    │ │     消息服务     │ │ 消息持久化服务   │ │
│ │ (UserService) │ │(ConversationS)│ │ (MessageService) │ │(MsgPersistenceS) │ │
│ │               │ │   ervice)     │ │                  │ │                  │ │
│ └───────────────┘ └───────────────┘ └──────────────────┘ └──────────────────┘ │
│                                                                          │
│ ┌───────────────┐ ┌───────────────┐ ┌──────────────────┐ ┌──────────────────┐ │
│ │   广播服务    │ │   事件服务    │ │     文件服务     │ │     认证服务     │ │
│ │(BroadcastServ)│ │ (EventService)│ │  (FileService)   │ │  (AuthService)   │ │
│ │     ice)      │ │               │ │                  │ │                  │ │
│ └───────────────┘ └───────────────┘ └──────────────────┘ └──────────────────┘ │
│                                                                          │
│ ┌───────────────┐ ┌───────────────┐ ┌──────────────────┐ ┌──────────────────┐ │
│ │   级联服务    │ │  MQ管理服务   │ │   在线状态服务   │ │      通知服务    │ │
│ │(CascadeServi) │ │(MQManagerServ)│ │ (PresenceService)│ │(NotificationSrv) │ │
│ │     ce)       │ │     ice)      │ │                  │ │                  │ │
│ └───────────────┘ └───────────────┘ └──────────────────┘ └──────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
```

## 技术栈选择

### 后端技术栈

| 技术组件 | 选择方案 | 版本要求 |
|----------|----------|----------|
| 编程语言 | Python | 3.12+ |
| Web框架 | FastAPI | 0.104+ |
| ASGI服务器 | Uvicorn | 0.24+ |
| 数据库 | MySQL | 8.0+ |
| ORM框架 | SQLAlchemy | 2.0+ |
| 数据库迁移 | Alembic | 1.12+ |
| 消息队列 | RabbitMQ | 3.12+ |
| MQ客户端 | aio-pika | 9.0+ |
| 缓存/在线状态 | Redis | 7.0+ |
| Redis客户端 | redis-py | 5.0+ |
| 认证 | JWT (自定义实现) | PyJWT 2.8+ |
| 密码加密 | bcrypt | 4.0+ |
| 配置管理 | Pydantic | 2.4+ |
| 测试 | pytest | 7.4+ |

### 开发工具

| 工具类型 | 选择方案 |
|----------|----------|
| 依赖管理 | Poetry |
| 代码格式化 | Black |
| 代码检查 | Flake8 / ruff |
| 类型检查 | mypy |
| API文档 | FastAPI自带Swagger/Redoc |

## 项目结构设计 (实际)

```
instant/
├── app/                          # 应用主目录
│   ├── main.py                   # FastAPI应用入口
│   ├── api/                      # API路由
│   │   ├── deps.py               # 依赖注入
│   │   └── v1/                   # API v1版本
│   │       ├── api.py            # 路由聚合
│   │       └── endpoints/        # 各模块API实现
│   ├── core/                     # 核心配置 (安全, Redis, RabbitMQ)
│   ├── crud/                     # 数据访问层 (CRUD操作)
│   ├── db/                       # 数据库会话管理
│   ├── models/                   # SQLAlchemy数据模型
│   ├── schemas/                  # Pydantic数据模式
│   └── services/                 # 业务逻辑服务
├── alembic/                      # 数据库迁移
├── tests/                        # 测试目录
├── front_end/                    # 前端Vue项目
├── scripts/                      # 辅助脚本
├── uploads/                      # 文件上传目录
├── pyproject.toml                # Poetry配置
└── alembic.ini                   # Alembic配置
```

## 数据库设计

### 数据库选择
采用 **MySQL 8.0+** 作为主要数据库，理由：
- 成熟稳定，性能优异
- 支持ACID事务
- 丰富的索引类型
- 完善的备份恢复机制
- 社区支持好

### 核心表设计

#### 1. 用户表 (users)
存储用户基本信息和状态

#### 2. 会话表 (conversations) 
存储会话基本信息 (单聊或群聊)

#### 3. 会话成员表 (conversation_members)
存储会话与用户的关系

#### 4. 消息表 (messages)
存储所有消息记录

#### 5. 文件表 (files)
存储上传文件的元数据

#### 6. 通知表 (notifications)
存储用户通知

详细表结构请参考 `app/models/` 目录下的具体模型文件。

## API接口设计 (扩展后)

### 接口设计原则

1.  **RESTful设计**: 使用标准HTTP方法，通过路径参数和请求体传递数据。
2.  **统一前缀**: 所有API均以 `/api/v1` 作为前缀。
3.  **依赖注入**: 使用FastAPI的依赖注入系统 (`Depends`) 来处理认证和数据库会话。
4.  **自动文档**: 接口通过Pydantic模型和类型提示自动在 `/docs` 和 `/redoc` 生成文档。

### 接口模块划分 (基于 `app/api/v1/api.py` 规划)

| 模块 | 前缀 | 核心功能 | 状态 |
|------|-----------|------------------------------------------|------|
| 认证 | `/auth` | 用户登录、注册、Token刷新 | 已实现 |
| 用户 | `/users` | 获取用户信息、搜索用户、更新用户资料 | 已实现 |
| 会话 | `/conversations`| 获取会话列表、创建单聊/群聊 | 已实现 |
| 消息 | `/messages` | 发送HTTP消息、获取历史消息、标记已读 | 已实现 |
| 文件 | `/files` | 上传/下载文件 | 已实现 |
| 群组 | `/groups` | 高级群组管理 (加人、踢人、修改群信息) | 已实现 |
| 通知 | `/notifications`| 获取/标记用户通知 | 已实现 |
| 实时 | `/realtime` | 提供WebSocket连接端点 | 已实现 |
| **广播** | `/broadcasts` | 发送系统广播、获取历史广播 | **待设计** |
| **事件** | `/events` | 上报事件、查询历史事件 | **待设计** |
| **级联** | `/cascade` | 获取MQ/SIP信息、同步平台数据 | **待设计** |

## 实时通信与消息队列设计 (V3.0 重构)

### 1. 核心思想：统一事件总线
采用 **Topic Exchange** 作为系统的统一消息总线。所有系统内产生的事件（如聊天消息、用户状态变更、广播通知等）都发布到这个中心交换机。不同的消费者按需订阅自己关心的主题（通过路由键模式匹配），实现模块间的完全解耦和高度可扩展性。

### 2. RabbitMQ 架构设计

*   **统一交换机 (Exchange)**:
    *   名称: `instant_exchange`
    *   类型: `topic`
    *   职责: 接收所有业务模块发布的消息，并根据路由键（Routing Key）分发给绑定的队列。

*   **核心队列 (Queues)**:
    1.  `persistence_queue`:
        *   **绑定键**: `chat.message.#`, `system.event`, `system.broadcast`
        *   **职责**: 用于持久化所有需要存储的消息，如聊天记录、事件、广播等。由**消息持久化服务**消费。
    2.  `realtime_push_queue`:
        *   **绑定键**: `chat.message.#`, `user.status.#`, `system.notification.#`
        *   **职责**: 用于实时推送。所有需要实时通知客户端的消息都进入此队列。由**实时推送服务(WebSocket Service)**消费。
    3.  `broadcast_process_queue`:
        *   **绑定键**: `system.broadcast`
        *   **职责**: 处理广播逻辑，例如需要将一条广播消息分发给所有在线用户。由**广播服务**消费。
    4.  `event_process_queue`:
        *   **绑定键**: `system.event`
        *   **职责**: 处理上报的事件。由**事件服务**消费。

*   **路由键 (Routing Key) 设计规范**:
    *   格式: `<domain>.<type>.<subtype>...`
    *   示例:
        *   聊天消息: `chat.message.conversation.{conversation_id}`
        *   用户上线: `user.status.online.{user_id}`
        *   用户下线: `user.status.offline.{user_id}`
        *   系统广播: `system.broadcast`
        *   系统事件: `system.event`
        *   会话变更通知: `system.notification.conversation.{conversation_id}`

### 3. 消息完整生命周期 (以发送聊天消息为例)

```
                                      ┌──────────────────────┐
                                      │  1. Client sends msg │
                                      │ (HTTP or WebSocket)  │
                                      └──────────┬───────────┘
                                                 │
                                                 ▼
                  ┌──────────────────────────────────────────────────┐
                  │ 2. FastAPI Backend (Message Endpoint/WS Service) │
                  │     - Validates input & user permissions         │
                  └──────────────────────┬───────────────────────────┘
                                         │
                                         ▼
                ┌──────────────────────────────────────────────────┐
                │ 3. Publish to RabbitMQ Topic Exchange            │
                │    - Exchange: instant_exchange                  │
                │    - Routing Key: chat.message.conversation.123  │
                └──────────────────────────────────────────────────┘
                                         │
                 ┌───────────────────────┼────────────────────────┐
                 │                       │                        │
                 ▼                       ▼                        ▼
┌──────────────────────────┐  ┌───────────────────────┐  ┌─────────────────────┐
│ 4a. Persistence Queue    │  │ 4b. Realtime Push Queue │  │ 4c. (Other Queues)  │
│ (Bound to chat.message.#)│  │(Bound to chat.message.#)│  │  ...                │
└───────────┬──────────────┘  └──────────┬────────────┘  └─────────────────────┘
            │                           │
            ▼                           │
┌──────────────────────────┐            │
│ 5a. Persistence Consumer │            │
│  - Receives message      │            │
│  - Saves to MySQL DB     │            │
└──────────────────────────┘            │
                                        │
                                        ▼
                           ┌──────────────────────────┐
                           │ 5b. Realtime Push Consumer│
                           │(WebSocket Service)        │
                           │- Finds target online users│
                           │- Pushes msg via WebSocket│
                           └──────────────────────────┘
```

## 核心模块设计 (V3.0)

### 分层架构

```
API Endpoints (app/api/v1/endpoints/)
     ↓
Services (app/services/) - 业务逻辑层
     ↓
CRUD (app/crud/) - 数据访问层，直接与数据库交互
     ↓
Models (app/models/) - SQLAlchemy数据模型层
```

### 核心服务职责

#### 1. WebSocket服务 (`websocket_service.py`)
*   管理所有用户的WebSocket连接。
*   处理心跳、用户输入状态 (`typing`)。
*   **新职责**: 作为**实时推送消费者**，订阅 `realtime_push_queue`，接收来自MQ的消息，并准确推送给目标客户端。
*   接收客户端消息（如果仍然支持WS发送），并将其发布到 `instant_exchange`。

#### 2. 消息持久化服务 (`persistence_service.py` - 新增)
*   **核心职责**: 作为**消息持久化消费者**，订阅 `persistence_queue`。
*   负责从队列中消费各种类型的消息（聊天、事件、广播等）。
*   将消息解析并存入对应的数据库表中（`messages`, `events`, `broadcasts`等）。
*   处理消息存储过程中的错误和重试逻辑。

#### 3. 广播服务 (`broadcast_service.py` - 新增)
*   提供发送广播的API接口 (`/broadcasts`)。
*   将广播请求发布到 `instant_exchange`，路由键为 `system.broadcast`。
*   **可选**: 作为消费者，订阅 `broadcast_process_queue`，处理复杂的广播逻辑，例如从数据库获取所有用户列表并为每个人生成单独的通知。

#### 4. 事件服务 (`event_service.py` - 新增)
*   提供上报事件的API接口 (`/events`)。
*   将事件数据发布到 `instant_exchange`，路由键为 `system.event`。
*   **可选**: 作为消费者，订阅 `event_process_queue`，处理事件的后续流程，如通知管理员、数据分析等。

#### 5. 用户/会话/消息服务 (现有)
*   这些服务主要负责提供API接口，处理HTTP请求，并将产生的业务事件发布到 `instant_exchange` 中，由下游消费者进行处理。

## 安全设计

### 1. 认证授权
- **Token认证**: 通过HTTP Header `Authorization: Bearer <token>` 或WebSocket的URL参数进行认证。
- **依赖注入**: `deps.py` 中定义了 `get_current_active_user` 等依赖，用于保护需要认证的路由。

### 2. 数据安全
- **密码哈希**: 使用 `bcrypt` 存储用户密码。
- **文件安全**: 通过 `file_service` 验证文件归属和权限。

### 3. 网络安全
- **CORS**: 在 `app/main.py` 中配置 `CORSMiddleware`，允许跨域请求。
- **请求限流**: (待实现) 可通过 `slowapi` 等库实现。

## 部署架构

(部署架构图保持不变, 思路适用)

### 容器化部署 (`docker-compose.yml`)
项目已提供 `docker-compose.yml` (或类似文件) 用于快速搭建包含以下服务的开发环境：
- `instant-app`: FastAPI应用服务
- `mysql`: 数据库
- `redis`: 缓存
- `rabbitmq`: 消息队列

### 生产环境部署
与设计类似，推荐使用K8s或多实例+负载均衡器的方式进行水平扩展。

### 健康检查与监控
- **健康检查**: (待实现) 可在 `/health` 端点检查数据库、Redis、RabbitMQ的连通性。
- **日志**: (当前使用Python内置logging) 可替换为 `structlog` 实现结构化日志。
- **监控**: (待实现) 可集成 `prometheus-client` 暴露 `/metrics` 端点。

## 开发流程

(开发流程保持不变, 描述准确)

### 1. 环境准备
```bash
# 安装Poetry
curl -sSL https://install.python-poetry.org | python3 -

# 创建项目
poetry new instant

# 安装依赖
poetry install

# 启动开发环境
docker-compose -f docker-compose.dev.yml up -d
```

### 2. 数据库迁移
```bash
# 生成迁移文件
alembic revision --autogenerate -m "description"

# 执行迁移
alembic upgrade head
```

### 3. 测试策略
```bash
# 运行后端测试
pytest tests/

# 运行前端测试
npm test --prefix front_end
```

这份概要设计文档涵盖了即时通讯系统的核心架构、技术选型、模块设计、安全考虑和部署方案，为后续的详细设计和开发实现提供了完整的指导框架。 