# 未读消息计数修复 - 测试验证指南

## 问题描述
用户离线期间收到的消息，在重新登录后对话列表中没有显示未读计数，只能看到历史消息。

## 修复内容
1. **改进会话列表同步** - 正确处理后端返回的未读计数
2. **新增未读状态同步函数** - 主动同步离线期间的未读消息状态  
3. **优化初始化流程** - 登录后自动同步未读消息
4. **WebSocket重连优化** - 重连后重新同步状态

## 测试步骤

### 测试场景1：基本离线消息未读计数
1. **准备工作**：
   - 用户A和用户B都已注册并能正常聊天
   - 确保用户A当前在线

2. **执行测试**：
   - 用户A退出应用（离线）
   - 用户B给用户A发送3-5条消息
   - 用户A重新登录

3. **验证结果**：
   - ✅ 用户A的对话列表中应该显示与用户B的对话有未读计数
   - ✅ 未读计数数字应该正确（例如显示"3"）
   - ✅ 点击进入对话后，未读计数应该清零
   - ✅ 应能看到完整的历史消息

### 测试场景2：多个对话的未读计数
1. **准备工作**：
   - 用户A和多个用户（B、C、D）都能正常聊天
   - 用户A离线

2. **执行测试**：
   - 用户B发送2条消息
   - 用户C发送1条消息  
   - 用户D发送3条消息
   - 用户A重新登录

3. **验证结果**：
   - ✅ 与用户B的对话显示未读计数"2"
   - ✅ 与用户C的对话显示未读计数"1"
   - ✅ 与用户D的对话显示未读计数"3"
   - ✅ 总的未读计数应该是6

### 测试场景3：网络重连后的同步
1. **执行测试**：
   - 用户A在线使用应用
   - 模拟网络断开（关闭WiFi）
   - 其他用户给用户A发送消息
   - 恢复网络连接

2. **验证结果**：
   - ✅ WebSocket重连后，未读计数应该正确更新
   - ✅ 控制台应该显示同步日志

## 调试信息

在浏览器控制台中查看以下日志：

```
📊 会话 {conversation_id} 有 {count} 条未读消息
🔄 开始同步未读消息状态...
📥 会话 {conversation_id} 需要同步 {count} 条未读消息  
✅ 会话 {conversation_id} 已同步 {count} 条未读消息
✅ 未读消息状态同步完成
📈 会话 {conversation_id} 未读计数更新为: {count}
```

## 常见问题排查

### 问题1：登录后仍然没有未读计数
**可能原因**：
- 后端API返回的会话列表中`unread_count`字段为0或null
- 检查网络请求，确认后端正确返回了未读计数

### 问题2：未读计数不准确
**可能原因**：
- 检查是否有重复计算
- 确认`syncUnreadMessageStatus`函数是否正确执行

### 问题3：WebSocket连接问题
**可能原因**：
- 检查WebSocket连接状态
- 确认用户token是否有效
- 查看控制台是否有连接错误

## 技术实现说明

### 核心修复函数
1. `syncUnreadMessageStatus()` - 同步未读消息状态
2. `updateConversationLastMessage()` - 更新对话最后消息和未读计数
3. `fetchConversations()` - 增强的会话列表获取

### 关键改进点
- 在用户登录后主动同步离线期间的未读消息
- WebSocket重连后重新同步状态
- 改进未读计数的增量更新逻辑
- 确保切换对话时正确清除未读状态 